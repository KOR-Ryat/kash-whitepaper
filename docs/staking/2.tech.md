---
sidebar_position: 2
---

# Technical Details

KASH는 다음과 같은 요구사항을 만족할 수 있도록 시스템을 디자인했습니다.

+ Pull-based Model : 각 사용자의 정보는 인출 등 각자의 트랜젝션이 발생되는 행동 시점에 실제로 계산되어 업데이트 된다.
+ Effortless Compounding : 이 외에 각 사용자가 복리 효과를 위해 직,간접적으로 자신의 정보를 업데이트 할 필요가 없어야 한다.
+ Flawless Compounding : 각 사용자는 매번 발생한 이자를 즉시 재예치 한 것과 완전히 동일한 복리 효과를 가져야 한다.

이 섹션에서는 KASH에서 이러한 조건을 만족하는 스테이킹 컨트랙트를 구현한 방법을 설명합니다.

---

**(Abandonded : 스테이킹 모델의 변화로 예전 시스템에 대한 설명을 담고 있습니다. 모델이 구체화 되면 업데이트 예정입니다.)**

이 섹션에서는 KASH 스테이킹의 "모두 자동 재예치" 및 "초기 가중치(Share) 차등" 모델을 구현하기 위한 핵심 기술적 구성 요소와 작동 방식을 설명합니다. 

본 설계는 사용자의 편의성을 극대화하면서도 `Early Staker Bonus`의 가치를 보존하고, 효율적인 온체인 연산을 목표로 합니다.

> Core Data Structure

스테이킹 시스템의 중심에는 사용자별 스테이킹 정보를 담는 `Position` 구조체와 시스템 전체 상태를 관리하는 전역 변수들이 있습니다.

1.  **`Position` Structure:**
    각 사용자의 스테이킹 활동은 개별 `Position`으로 기록됩니다. 새로운 스테이킹마다 새로운 `Position`이 생성됩니다.
    *   `owner (address)`: 해당 포지션의 소유자 주소.
    *   `initialShares (uint256)`: 사용자가 최초 스테이킹 시 `Actual Staked Amount`와 `Early Staker Bonus`를 반영하여 할당받은 총 주식(Share) 수량. 이 값은 포지션이 유지되는 동안 변경되지 않습니다 (부분 출금 시 해당 분량만큼 감소).
    *   `actualStakedAmountAtCreation (uint256)`: (선택적, 정보 제공 및 분석용) 사용자가 해당 포지션 생성 시 실제로 예치한 KASH 토큰의 양.
    *   `creationTimestamp (uint256)`: 포지션이 생성된 시점의 블록 타임스탬프 (주로 정보 제공 및 `Early Staker Bonus` 계산 검증용).

2.  **Global State Variables:**
    스테이킹 컨트랙트는 다음과 같은 주요 전역 변수를 유지 관리합니다.
    *   `globalTotalInitialShares (uint256)`: 현재 시스템에 스테이킹된 모든 활성 포지션들의 `initialShares` 총합. 이 값은 새로운 스테이킹 또는 출금 발생 시 업데이트됩니다.
    *   `globalRewardsPerShare (uint256)`: "1 단위의 `initialShare`가 현재 얼마만큼의 KASH 토큰 가치를 가지는지"를 나타내는 핵심 지수. 이 지수는 초기에 `PRECISION` 값 (예: `10^18`, 즉 1 share = 1 KASH로 시작을 의미)으로 설정되며, 매 epoch마다 보상이 분배될 때마다 증가합니다.
    *   `stakingToken (IERC20)`: 스테이킹에 사용되는 KASH 토큰 컨트랙트 주소.
    *   `T_OPEN (uint256)`, `T_START (uint256)`, `EPOCH_DURATION (uint256)` 등: Core Principles에서 정의된 시간 관련 상수들.
    *   `currentEpoch (uint256)`: 현재 진행된 에포크 수.

> initialShares

사용자가 KASH 토큰을 스테이킹할 때, 시스템은 예치된 실제 토큰 양(`_actualAmount`)과 스테이킹 시점(`T_position`)을 기준으로 `Early Staker Bonus` (`_bonusFactor`)를 계산합니다. 이 보너스 팩터는 사용자가 받게 될 `initialShares`를 결정하는 데 사용됩니다.

$$
\text{initialShares} = \text{\_actualAmount} \times (1 + \text{\_bonusFactor})
$$

(실제 구현에서는 고정소수점 연산을 위해 `PRECISION` 값을 사용합니다: `initialShares = _actualAmount * (PRECISION + _bonusFactorScaled) / PRECISION;` 여기서 `_bonusFactorScaled`는 `_bonusFactor * PRECISION`입니다.)

이렇게 계산된 `initialShares`는 해당 사용자의 `Position`에 기록되며, 이는 사용자의 전체 스테이킹 풀 내에서의 "지분율 기여도"를 나타냅니다. `_bonusFactor`가 높을수록 동일한 `_actualAmount`에 대해 더 많은 `initialShares`를 획득하게 됩니다.

> globalRewardsPerShare

매 epoch마다 (Keeper 또는 권한 있는 계정에 의해) `updateEpoch` 함수가 호출되어 보상을 분배하고 `globalRewardsPerShare` 지수를 업데이트합니다.

1.  **`_epochReward` 수령:** 해당 epoch에 분배될 총 KASH 보상액 (`Reward_{Epoch,k}`)을 함수 인자로 전달받습니다.
2.  **사전 조건 확인:** 현재 시간이 `T_START` 이후이고, 이전 epoch이 정상적으로 처리되었는지 등을 확인합니다.
3.  **`globalRewardsPerShare` 업데이트:**
    *   `totalKASHValueRepresentedByShares_before = globalTotalInitialShares * globalRewardsPerShare_old / PRECISION;`
        *   (이자 분배 전, 현재 모든 `share`가 나타내는 총 KASH 가치)
    *   `totalKASHValueRepresentedByShares_after = totalKASHValueRepresentedByShares_before + _epochReward;`
        *   (이번 epoch 이자를 더한 후의 총 KASH 가치)
    *   **If `globalTotalInitialShares > 0`:**
        *   `globalRewardsPerShare_new = totalKASHValueRepresentedByShares_after * PRECISION / globalTotalInitialShares;`
    *   이 새로운 `globalRewardsPerShare_new` 값이 저장되어 다음 epoch까지 유지됩니다.

이 과정을 통해, 시스템에 예치된 총 KASH (기존 스테이킹된 가치 + 신규 이자)를 총 `share` 수로 나눈 값이 새로운 "1 share당 KASH 가치"가 됩니다. 결과적으로, 모든 `share` 보유자는 자신의 `share` 수에 비례하여 이자 혜택을 자동으로 누리게 됩니다.

> User Actions

사용자는 스테이킹 컨트랙트와 상호작용하여 KASH를 예치(스테이킹)하거나 인출(철회)할 수 있습니다.

1.  Staking (예치):
    *   사용자가 `_amount` 만큼의 KASH를 예치합니다.
    *   시스템은 현재 시점을 기준으로 `Early Staker Bonus`를 계산합니다.
    *   위에서 설명한 방식으로 `initialShares`를 계산하여 사용자의 새 `Position`에 기록합니다.
    *   `globalTotalInitialShares`에 새로 생성된 `initialShares`만큼을 더합니다.
    *   사용자로부터 `_amount`의 KASH를 컨트랙트로 전송받습니다.

2.  Withdrawing (철회):
    *   사용자는 자신이 보유한 `Position`에서 특정 수량의 KASH 토큰(`_tokenAmountToWithdraw`)을 인출하기를 요청합니다.
    *   시스템은 현재 `globalRewardsPerShare`를 기준으로 `_tokenAmountToWithdraw`에 해당하는 `sharesToRedeem`을 계산합니다:
        *   `sharesToRedeem = _tokenAmountToWithdraw * PRECISION / globalRewardsPerShare;`
    *   사용자의 해당 `Position`에서 `initialShares`를 `sharesToRedeem` 만큼 차감합니다. (충분한 `share`가 있는지 확인 필요)
    *   `globalTotalInitialShares`에서 `sharesToRedeem` 만큼을 차감합니다.
    *   컨트랙트는 사용자에게 `_tokenAmountToWithdraw` 만큼의 KASH 토큰을 전송합니다.
    *   부분 인출 후 남은 `initialShares`는 계속해서 자동으로 복리 이자를 받습니다.

> Position Value

사용자 또는 외부 시스템은 언제든지 특정 `Position`의 현재 KASH 가치를 조회할 수 있습니다.

$$
\text{Current Position KASH Value} = \frac{\text{position.initialShares} \times \text{globalRewardsPerShare}}{\text{PRECISION}}
$$

이 값은 해당 포지션이 최초 스테이킹된 이후 발생한 모든 이자가 복리 효과를 통해 자동으로 재투자된 결과를 반영합니다. 사용자는 별도의 이자 청구(claim) 행위 없이 자신의 포지션 가치가 증가하는 것을 확인할 수 있습니다.

> Key Advantages

*   **Effortless Compounding for Users:** 사용자는 추가 트랜잭션 없이 자동으로 복리 혜택을 받습니다.
*   **Fairness and Bonus Persistence:** `Early Staker Bonus`는 `initialShares` 형태로 영구적으로 반영되어, 초기 기여자의 혜택이 희석되지 않습니다.
*   **Gas Efficiency:** `updateEpoch` 연산은 스테이킹된 사용자 수와 무관하게 O(1) 복잡도를 가집니다. 스테이킹 및 출금 연산도 상대적으로 가볍습니다.
*   **Simplicity:** 다중 지수 모델이나 개별 사용자 업데이트 방식에 비해 컨트랙트 로직이 현저히 단순화됩니다.
*   **No Wrapped/Rebasing Tokens:** 사용자는 순수 KASH ERC-20 토큰을 직접 다루며, 토큰 잔액이 변하는 혼란을 겪지 않습니다.